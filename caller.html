<script>
(function () {
  var ORIGIN = "https://testing.saltbooks.com";
  var BRIDGE_PATH = "/bridge.js"; // Update to /bridge.html if deployment changed
  var DAYS = 365;

  function getCookie(name) {
    var m = document.cookie.match(new RegExp("(^|; )" + name.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&") + "=([^;]*)"));
    return m ? decodeURIComponent(m[2]) : null;
  }

  function setCookie(name, value, days, sameSite) {
    var maxAge = "; Max-Age=" + String(days * 24 * 60 * 60);
    var secure = (location.protocol === "https:") ? "; Secure" : "";
    document.cookie = name + "=" + encodeURIComponent(value) +
      "; Path=/" + maxAge + "; SameSite=" + (sameSite || "Lax") + secure;
  }

  // 1) Get current domain to send to bridge
  var localFirst = location.hostname.toLowerCase();

  // 2) Ask bridge for global first domain (cross-domain test)
  console.log("Creating iframe for bridge communication");
  console.log("Bridge URL:", ORIGIN + BRIDGE_PATH);
  console.log("Current domain:", localFirst);
  
  var f = document.createElement("iframe");
  f.style.position = "fixed";
  f.style.left = "-9999px";
  f.style.top = "-9999px";
  f.style.width = "1px";
  f.style.height = "1px";
  f.style.border = "0";
  f.src = ORIGIN + BRIDGE_PATH;
  
  f.onerror = function() {
    console.error("Iframe failed to load");
  };

  function cleanup() {
    window.removeEventListener("message", onMsg);
    try { if (f.parentNode) f.parentNode.removeChild(f); } catch (err) {}
  }

  function onMsg(e) {
    console.log("Received message:", e.data, "from origin:", e.origin);
    if (e.origin !== ORIGIN) {
      console.log("Origin mismatch. Expected:", ORIGIN, "Got:", e.origin);
      return;
    }
    if (!e.data || e.data.type !== "GLOBAL_FIRST_DOMAIN") {
      console.log("Message type mismatch. Expected: GLOBAL_FIRST_DOMAIN, Got:", e.data ? e.data.type : "no data");
      return;
    }

    var globalFirst = (e.data.first_domain || "").toLowerCase();
    console.log("Global first domain received:", globalFirst);

    if (globalFirst) {
      alert("First Domain: " + globalFirst);
    } else {
      alert("No first domain found");
    }

    cleanup();
  }

  window.addEventListener("message", onMsg, false);

  f.onload = function () {
    console.log("Iframe loaded successfully");
    // Add delay to ensure bridge script is fully loaded and ready
    setTimeout(function() {
      try {
        console.log("Sending message to bridge:", { type: "GET_OR_SET_GLOBAL_FIRST_DOMAIN", domain: localFirst });
        f.contentWindow.postMessage(
          { type: "GET_OR_SET_GLOBAL_FIRST_DOMAIN", domain: localFirst },
          ORIGIN
        );
        console.log("Message sent to bridge");
        
        // Set timeout to detect if no response is received
        setTimeout(function() {
          console.warn("No response received from bridge after 2 seconds. Bridge may not be deployed at:", ORIGIN + "/bridge.js");
        }, 2000);
      } catch (err) {
        console.error("Error sending message to bridge:", err);
      }
    }, 100); // 100ms delay
  };

  (document.body || document.documentElement).appendChild(f);
})();
</script>
