<!DOCTYPE html>
<html>
<head><title>Fetch-based Bridge Caller</title></head>
<body>
<h1>Cross-Domain Cookie Bridge (Fetch)</h1>
<div id="status">Loading...</div>
<div id="result"></div>

<script>
(function() {
  const BRIDGE_URL = "https://testing.saltbooks.com";
  const status = document.getElementById('status');
  const result = document.getElementById('result');
  
  console.log("Starting fetch-based bridge test...");
  status.textContent = "Sending request to bridge...";
  
  // Get current domain
  const currentDomain = location.hostname.toLowerCase();
  console.log("Current domain:", currentDomain);
  
  // Make fetch request to Worker
  fetch(BRIDGE_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include', // Include cookies
    body: JSON.stringify({
      domain: currentDomain
    })
  })
  .then(response => {
    console.log("Response received:", response.status);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(data => {
    console.log("Bridge response:", data);
    status.textContent = "✅ SUCCESS: Bridge communication working!";
    result.innerHTML = `
      <h3>Result:</h3>
      <p><strong>First Domain:</strong> ${data.first_domain}</p>
      <p><strong>Set Now:</strong> ${data.set_now ? 'Yes (first visit)' : 'No (returning)'}</p>
      <p><strong>Response Type:</strong> ${data.type}</p>
    `;
    
    // Show alert like original caller
    alert(`First Domain: ${data.first_domain}`);
  })
  .catch(error => {
    console.error("Bridge request failed:", error);
    status.textContent = "❌ ERROR: " + error.message;
    result.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
  });
})();
</script>
</body>
</html>
